<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—É–¥–∏–æ-–∫–ª–∏–µ–Ω—Ç –∏–Ω—Ç–µ—Ä–≤—å—é</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .question {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-size: 18px;
        }
        .logs {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ –ê—É–¥–∏–æ-–∫–ª–∏–µ–Ω—Ç –∏–Ω—Ç–µ—Ä–≤—å—é</h1>
        
        <div id="status" class="status info">–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é</div>
        
        <div>
            <button id="connectBtn" onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button id="startAudioBtn" onclick="startAudio()" disabled>–ù–∞—á–∞—Ç—å –∞—É–¥–∏–æ</button>
            <button id="stopAudioBtn" onclick="stopAudio()" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞—É–¥–∏–æ</button>
        </div>
        
        <div class="question" id="question">–í–æ–ø—Ä–æ—Å –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</div>
        
        <h3>üìä –õ–æ–≥–∏</h3>
        <div id="logs" class="logs"></div>
    </div>

    <script>
        const SAMPLE_RATE = 48000;
        const CHUNK_MS = 20;
        const CHANNELS = 1;
        
        let ws = null;
        let audioCtx = null;
        let micStream = null;
        let captureNode = null;
        let audioBuffer = null;
        let connected = false;
        let audioStarted = false;
        let seq = 0;
        
        // –ü—Ä–æ—Å—Ç–æ–π –±—É—Ñ–µ—Ä –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        class SimpleAudioBuffer {
            constructor() {
                this.buffers = [];
                this.isPlaying = false;
                this.currentSource = null;
            }
            
            addAudioData(pcm16Data) {
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º PCM16 –≤ Float32
                const float32Data = new Float32Array(pcm16Data.length);
                for (let i = 0; i < pcm16Data.length; i++) {
                    float32Data[i] = Math.max(-1, Math.min(1, pcm16Data[i] / 0x8000));
                }
                
                this.buffers.push(float32Data);
                log(`–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –±—É—Ñ–µ—Ä: ${float32Data.length} —Å—ç–º–ø–ª–æ–≤, –≤—Å–µ–≥–æ –±—É—Ñ–µ—Ä–æ–≤: ${this.buffers.length}`);
                
                // –ï—Å–ª–∏ –Ω–µ –∏–≥—Ä–∞–µ–º, –Ω–∞—á–∏–Ω–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                if (!this.isPlaying) {
                    this.playNext();
                }
            }
            
            async playNext() {
                if (this.buffers.length === 0) {
                    this.isPlaying = false;
                    return;
                }
                
                this.isPlaying = true;
                const audioData = this.buffers.shift();
                
                try {
                    // –°–æ–∑–¥–∞–µ–º AudioBuffer
                    const audioBuffer = audioCtx.createBuffer(1, audioData.length, 48000);
                    audioBuffer.copyToChannel(audioData, 0);
                    
                    // –°–æ–∑–¥–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
                    const source = audioCtx.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(audioCtx.destination);
                    
                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                    source.onended = () => {
                        this.currentSource = null;
                        this.playNext(); // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º —Å–ª–µ–¥—É—é—â–∏–π –±—É—Ñ–µ—Ä
                    };
                    
                    this.currentSource = source;
                    source.start();
                    log(`üîä –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ: ${audioData.length} —Å—ç–º–ø–ª–æ–≤`);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', error);
                    log(`‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: ${error.message}`);
                    this.isPlaying = false;
                }
            }
            
            stop() {
                if (this.currentSource) {
                    this.currentSource.stop();
                    this.currentSource = null;
                }
                this.isPlaying = false;
                this.buffers = [];
            }
        }
        
        function log(message) {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            logs.innerHTML += `[${time}] ${message}<br>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function makeFrame(payload, codec = 1) {
            const header = new ArrayBuffer(14);
            const dv = new DataView(header);
            dv.setUint8(0, 1); // version
            dv.setUint8(1, codec);
            dv.setUint32(2, seq++, true);
            const nowNs = BigInt(Math.floor(performance.timeOrigin * 1e6) + Math.floor(performance.now() * 1e6));
            dv.setBigUint64(6, nowNs, true);
            return new Blob([header, payload]);
        }
        
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
        async function connect() {
            if (connected) return;
            
            const roomId = new URLSearchParams(window.location.search).get('room');
            if (!roomId) {
                updateStatus('‚ùå –ù–µ —É–∫–∞–∑–∞–Ω ID –∫–æ–º–Ω–∞—Ç—ã –≤ URL', 'error');
                return;
            }
            
            updateStatus('üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket...', 'info');
            log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket...');
            
            try {
                ws = new WebSocket(`ws://localhost:8000/ws/audio/${roomId}`);
                ws.binaryType = 'arraybuffer';
                
                ws.onopen = () => {
                    connected = true;
                    updateStatus('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
                    log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º handshake
                    ws.send(JSON.stringify({
                        type: 'hello',
                        codec: 'pcm16',
                        sr: SAMPLE_RATE,
                        ch: CHANNELS,
                        chunk_ms: CHUNK_MS
                    }));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('startAudioBtn').disabled = false;
                };
                
                ws.onmessage = (msg) => {
                    if (typeof msg.data === 'string') {
                        // –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        const data = JSON.parse(msg.data);
                        log(`–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${msg.data}`);
                        
                        if (data.type === 'question') {
                            document.getElementById('question').textContent = data.question;
                            log(`–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å: ${data.question}`);
                        }
                    } else {
                        // –ë–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–∞—É–¥–∏–æ)
                        handleAudioData(msg.data);
                    }
                };
                
                ws.onclose = () => {
                    connected = false;
                    updateStatus('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω', 'error');
                    log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    document.getElementById('startAudioBtn').disabled = true;
                    document.getElementById('stopAudioBtn').disabled = true;
                };
                
                ws.onerror = (error) => {
                    updateStatus('‚ùå –û—à–∏–±–∫–∞ WebSocket', 'error');
                    log(`–û—à–∏–±–∫–∞ WebSocket: ${error}`);
                };
                
            } catch (error) {
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
                log(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`);
            }
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
            if (audioStarted) {
                stopAudio();
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        function handleAudioData(buf) {
            if (!audioBuffer) {
                log('‚ùå –ê—É–¥–∏–æ –±—É—Ñ–µ—Ä –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            const dv = new DataView(buf);
            const version = dv.getUint8(0);
            const codec = dv.getUint8(1);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç: –ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª –∏–ª–∏ —á–∞–Ω–∫–∏
            if (buf.byteLength > 14) {
                // –ü–æ–ª–Ω—ã–π –∞—É–¥–∏–æ-—Ñ–∞–π–ª: version(1) + codec(1) + size(4) + data
                const totalSize = dv.getUint32(2, true);
                log(`–ü–æ–ª–Ω—ã–π –∞—É–¥–∏–æ-—Ñ–∞–π–ª: –≤–µ—Ä—Å–∏—è=${version}, –∫–æ–¥–µ–∫=${codec}, —Ä–∞–∑–º–µ—Ä=${totalSize} –±–∞–π—Ç`);
                
                if (codec === 1) { // PCM16
                    const pcm = new Int16Array(buf, 6); // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ 6 –±–∞–π—Ç
                    log(`–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª: ${pcm.length} —Å—ç–º–ø–ª–æ–≤`);
                    audioBuffer.addAudioData(pcm);
                }
            } else {
                // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç —á–∞–Ω–∫–æ–≤ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
                const seq = dv.getUint32(2, true);
                const ptsNs = dv.getBigUint64(6, true);
                
                log(`–û–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞–Ω–∫–∞: –≤–µ—Ä—Å–∏—è=${version}, –∫–æ–¥–µ–∫=${codec}, seq=${seq}, —Ä–∞–∑–º–µ—Ä=${buf.byteLength}`);
                
                if (codec === 1) { // PCM16
                    const pcm = new Int16Array(buf, 14);
                    audioBuffer.addAudioData(pcm);
                }
            }
        }
        
        // –ó–∞–ø—É—Å–∫ –∞—É–¥–∏–æ
        async function startAudio() {
            if (audioStarted) return;
            
            try {
                updateStatus('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ...', 'info');
                log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ...');
                
                // –°–æ–∑–¥–∞–µ–º AudioContext
                audioCtx = new (window.AudioContext || window.webkitAudioContext)({ 
                    sampleRate: SAMPLE_RATE 
                });
                
                // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º AudioContext –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if (audioCtx.state === 'suspended') {
                    await audioCtx.resume();
                }
                
                // –°–æ–∑–¥–∞–µ–º –±—É—Ñ–µ—Ä –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                audioBuffer = new SimpleAudioBuffer();
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                micStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: CHANNELS,
                        sampleRate: SAMPLE_RATE,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: false
                    }
                });
                
                // –°–æ–∑–¥–∞–µ–º AudioWorklet –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞
                await audioCtx.audioWorklet.addModule(URL.createObjectURL(new Blob([`
                    class CaptureProcessor extends AudioWorkletProcessor {
                        static get parameterDescriptors() { return []; }
                        
                        constructor() {
                            super();
                            this.buf = [];
                            this.samplesPerChunk = Math.round(${SAMPLE_RATE} * ${CHUNK_MS} / 1000);
                            this.acc = 0;
                        }
                        
                        process(inputs) {
                            const input = inputs[0][0];
                            if (!input) return true;
                            
                            if (!this.tmp) this.tmp = new Float32Array(this.samplesPerChunk);
                            
                            for (let i = 0; i < input.length; i++) {
                                const v = input[i];
                                this.tmp[this.acc++] = v;
                                
                                if (this.acc === this.samplesPerChunk) {
                                    // Float32 [-1,1] -> PCM16LE
                                    const pcm = new Int16Array(this.samplesPerChunk);
                                    for (let j = 0; j < pcm.length; j++) {
                                        let s = Math.max(-1, Math.min(1, this.tmp[j]));
                                        pcm[j] = (s < 0 ? s * 0x8000 : s * 0x7FFF) | 0;
                                    }
                                    this.port.postMessage(pcm.buffer, [pcm.buffer]);
                                    this.acc = 0;
                                }
                            }
                            return true;
                        }
                    }
                    registerProcessor('capture', CaptureProcessor);
                `], { type: 'application/javascript' })));
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
                const micSource = audioCtx.createMediaStreamSource(micStream);
                captureNode = new AudioWorkletNode(audioCtx, 'capture');
                micSource.connect(captureNode);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã–µ
                captureNode.port.onmessage = (e) => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        const frame = makeFrame(e.data, 1);
                        ws.send(frame);
                    }
                };
                
                audioStarted = true;
                updateStatus('‚úÖ –ê—É–¥–∏–æ –∑–∞–ø—É—â–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ', 'success');
                log('–ê—É–¥–∏–æ –∑–∞–ø—É—â–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
                document.getElementById('startAudioBtn').disabled = true;
                document.getElementById('stopAudioBtn').disabled = false;
                
            } catch (error) {
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞—É–¥–∏–æ', 'error');
                log(`–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞—É–¥–∏–æ: ${error.message}`);
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞—É–¥–∏–æ:', error);
            }
        }
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞—É–¥–∏–æ
        function stopAudio() {
            if (!audioStarted) return;
            
            try {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞—Ö–≤–∞—Ç
                if (micStream) {
                    micStream.getTracks().forEach(track => track.stop());
                    micStream = null;
                }
                
                if (captureNode) {
                    captureNode.disconnect();
                    captureNode = null;
                }
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                if (audioBuffer) {
                    audioBuffer.stop();
                    audioBuffer = null;
                }
                
                if (audioCtx) {
                    audioCtx.close();
                    audioCtx = null;
                }
                
                audioStarted = false;
                updateStatus('‚úÖ –ê—É–¥–∏–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'info');
                log('–ê—É–¥–∏–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
                document.getElementById('startAudioBtn').disabled = false;
                document.getElementById('stopAudioBtn').disabled = true;
                
            } catch (error) {
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞—É–¥–∏–æ', 'error');
                log(`–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞—É–¥–∏–æ: ${error.message}`);
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = () => {
            log('–ê—É–¥–∏–æ-–∫–ª–∏–µ–Ω—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—É–¥–∏–æ-–∫–ª–∏–µ–Ω—Ç –¥–ª—è –∏–Ω—Ç–µ—Ä–≤—å—é</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .status.connecting { background: #fff3cd; color: #856404; }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .audio-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .question-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 20px;
            border-radius: 5px;
            margin: 15px 0;
            min-height: 100px;
        }
        .logs {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ –ê—É–¥–∏–æ-–∫–ª–∏–µ–Ω—Ç –¥–ª—è –∏–Ω—Ç–µ—Ä–≤—å—é</h1>
        
        <div id="status" class="status disconnected">
            –û—Ç–∫–ª—é—á–µ–Ω–æ
        </div>
        
        <div class="controls">
            <button id="connect" class="btn-primary">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button id="startAudio" class="btn-success" disabled>–ù–∞—á–∞—Ç—å –∞—É–¥–∏–æ</button>
            <button id="stopAudio" class="btn-danger" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞—É–¥–∏–æ</button>
            <button id="disconnect" class="btn-secondary" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>
        
        <div class="audio-info">
            <h3>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞—É–¥–∏–æ</h3>
            <p><strong>–ß–∞—Å—Ç–æ—Ç–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏:</strong> <span id="sampleRate">-</span> –ì—Ü</p>
            <p><strong>–ö–∞–Ω–∞–ª—ã:</strong> <span id="channels">-</span></p>
            <p><strong>–†–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞:</strong> <span id="chunkSize">-</span> –º—Å</p>
            <p><strong>–°—Ç–∞—Ç—É—Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:</strong> <span id="micStatus">-</span></p>
            <p><strong>–°—Ç–∞—Ç—É—Å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:</strong> <span id="playStatus">-</span></p>
        </div>
        
        <div class="question-display">
            <h3>üìù –¢–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å</h3>
            <div id="questionText">–í–æ–ø—Ä–æ—Å –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</div>
        </div>
        
        <div class="logs">
            <div id="logOutput">–õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room') || 'default_room';
        const WS_URL = `ws://${window.location.host}/ws/audio/${roomId}`;
        const SAMPLE_RATE = 48000;
        const CHUNK_MS = 20;
        const CHANNELS = 1;
        const BUFFER_SIZE = 2; // —Å–µ–∫—É–Ω–¥—ã –±—É—Ñ–µ—Ä–∞

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let audioCtx, micStream, ws, playNode, captureNode, player, seq = 0;
        let started = false, connected = false;
        let playBuffer;

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const statusEl = document.getElementById('status');
        const connectBtn = document.getElementById('connect');
        const startAudioBtn = document.getElementById('startAudio');
        const stopAudioBtn = document.getElementById('stopAudio');
        const disconnectBtn = document.getElementById('disconnect');
        const questionTextEl = document.getElementById('questionText');
        const logOutputEl = document.getElementById('logOutput');

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logOutputEl.innerHTML += `[${timestamp}] ${message}\n`;
            logOutputEl.scrollTop = logOutputEl.scrollHeight;
            console.log(message);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(status, message) {
            statusEl.className = `status ${status}`;
            statusEl.textContent = message;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ñ—Ä–µ–π–º–∞
        function makeFrame(payload, codec = 1) {
            const header = new ArrayBuffer(14);
            const dv = new DataView(header);
            dv.setUint8(0, 1); // version
            dv.setUint8(1, codec);
            dv.setUint32(2, seq++, true);
            const nowNs = BigInt(Math.floor(performance.timeOrigin * 1e6) + Math.floor(performance.now() * 1e6));
            dv.setBigUint64(6, nowNs, true);
            return new Blob([header, payload]);
        }

        // –ö–æ–ª—å—Ü–µ–≤–æ–π –±—É—Ñ–µ—Ä –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        class RingBuffer {
            constructor(capacity) {
                this.buf = new Float32Array(capacity);
                this.r = 0;
                this.w = 0;
                this.len = 0;
            }
            
            push(data) {
                const n = data.length;
                if (n > this.buf.length) return;
                let rem = n, offset = 0;
                while (rem) {
                    const space = Math.min(rem, this.buf.length - this.w);
                    this.buf.set(data.subarray(offset, offset + space), this.w);
                    this.w = (this.w + space) % this.buf.length;
                    rem -= space;
                    offset += space;
                }
                this.len = Math.min(this.len + n, this.buf.length);
            }
            
            pull(n) {
                if (this.len < n) return null;
                const out = new Float32Array(n);
                let rem = n, offset = 0;
                while (rem) {
                    const space = Math.min(rem, this.buf.length - this.r);
                    out.set(this.buf.subarray(this.r, this.r + space), offset);
                    this.r = (this.r + space) % this.buf.length;
                    rem -= space;
                    offset += space;
                }
                this.len -= n;
                return out;
            }
        }

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
        async function connect() {
            if (connected) return;
            
            updateStatus('connecting', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
            log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket...');
            
            try {
                ws = new WebSocket(WS_URL);
                ws.binaryType = 'arraybuffer';
                
                ws.onopen = () => {
                    connected = true;
                    updateStatus('connected', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
                    log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±—É—Ñ–µ—Ä –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Å—Ä–∞–∑—É
                    if (!playBuffer) {
                        playBuffer = new RingBuffer(SAMPLE_RATE * 2); // ~2s –±—É—Ñ–µ—Ä–∞
                        globalThis.__rb__ = playBuffer;
                        log('–ë—É—Ñ–µ—Ä –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏');
                    }
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º handshake
                    ws.send(JSON.stringify({
                        type: 'hello',
                        codec: 'pcm16',
                        sr: SAMPLE_RATE,
                        ch: CHANNELS,
                        chunk_ms: CHUNK_MS
                    }));
                    
                    connectBtn.disabled = true;
                    startAudioBtn.disabled = false;
                    disconnectBtn.disabled = false;
                };
                
                ws.onmessage = (msg) => {
                    if (typeof msg.data === 'string') {
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                        log(`–ü–æ–ª—É—á–µ–Ω–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${msg.data}`);
                        try {
                            const data = JSON.parse(msg.data);
                            handleControlMessage(data);
                        } catch (e) {
                            log(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: ${e.message}`);
                        }
                    } else {
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∏–Ω–∞—Ä–Ω—ã—Ö –∞—É–¥–∏–æ-–¥–∞–Ω–Ω—ã—Ö
                        log(`–ü–æ–ª—É—á–µ–Ω—ã –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: ${msg.data.byteLength} –±–∞–π—Ç`);
                        handleAudioData(msg.data);
                    }
                };
                
                ws.onclose = () => {
                    connected = false;
                    updateStatus('disconnected', '–û—Ç–∫–ª—é—á–µ–Ω–æ');
                    log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
                    
                    connectBtn.disabled = false;
                    startAudioBtn.disabled = true;
                    stopAudioBtn.disabled = true;
                    disconnectBtn.disabled = true;
                };
                
                ws.onerror = (error) => {
                    log(`–û—à–∏–±–∫–∞ WebSocket: ${error}`);
                    updateStatus('disconnected', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                };
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`);
                updateStatus('disconnected', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–ø—Ä–∞–≤–ª—è—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        function handleControlMessage(data) {
            log(`–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${JSON.stringify(data)}`);
            
            switch (data.type) {
                case 'question':
                    questionTextEl.textContent = data.question;
                    log(`–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å: ${data.question}`);
                    break;
                case 'interview_completed':
                    questionTextEl.textContent = '–ò–Ω—Ç–µ—Ä–≤—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ!';
                    log('–ò–Ω—Ç–µ—Ä–≤—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                    break;
                case 'error':
                    log(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${data.message}`);
                    break;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ-–¥–∞–Ω–Ω—ã—Ö –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        function handleAudioData(buf) {
            if (!playBuffer) {
                log('playBuffer –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            const dv = new DataView(buf);
            const version = dv.getUint8(0);
            const codec = dv.getUint8(1);
            const seq = dv.getUint32(2, true);
            const ptsNs = dv.getBigUint64(6, true);
            
            log(`–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ: –≤–µ—Ä—Å–∏—è=${version}, –∫–æ–¥–µ–∫=${codec}, seq=${seq}, —Ä–∞–∑–º–µ—Ä=${buf.byteLength}`);
            
            if (codec === 1) { // PCM16
                const pcm = new Int16Array(buf, 14);
                const f32 = new Float32Array(pcm.length);
                for (let i = 0; i < pcm.length; i++) {
                    f32[i] = Math.max(-1, Math.min(1, pcm[i] / 0x8000));
                }
                playBuffer.push(f32);
                log(`–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –±—É—Ñ–µ—Ä: ${f32.length} —Å—ç–º–ø–ª–æ–≤, –≤—Å–µ–≥–æ –≤ –±—É—Ñ–µ—Ä–µ: ${playBuffer.len} —Å—ç–º–ø–ª–æ–≤`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±—É—Ñ–µ—Ä –≤ PlayerProcessor (–µ—Å–ª–∏ –∞—É–¥–∏–æ –∑–∞–ø—É—â–µ–Ω–æ)
                if (player && player.port) {
                    player.port.postMessage({type: 'setBuffer', buffer: playBuffer});
                }
            } else {
                log(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–æ–¥–µ–∫: ${codec}`);
            }
        }

        // –ó–∞–ø—É—Å–∫ –∞—É–¥–∏–æ
        async function startAudio() {
            if (started) return;
            
            try {
                log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ...');
                
                // –°–æ–∑–¥–∞–µ–º AudioContext
                audioCtx = new (window.AudioContext || window.webkitAudioContext)({ 
                    sampleRate: SAMPLE_RATE 
                });
                
                // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º AudioContext (—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö)
                if (audioCtx.state === 'suspended') {
                    await audioCtx.resume();
                    log('AudioContext –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω');
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º AudioWorklet –º–æ–¥—É–ª–∏
                await audioCtx.audioWorklet.addModule(URL.createObjectURL(new Blob([`
                    class CaptureProcessor extends AudioWorkletProcessor {
                        static get parameterDescriptors() { return []; }
                        
                        constructor() {
                            super();
                            this.samplesPerChunk = Math.round(${SAMPLE_RATE} * ${CHUNK_MS} / 1000);
                            this.acc = 0;
                            this.tmp = new Float32Array(this.samplesPerChunk);
                        }
                        
                        process(inputs) {
                            const input = inputs[0][0];
                            if (!input) return true;
                            
                            for (let i = 0; i < input.length; i++) {
                                this.tmp[this.acc++] = input[i];
                                if (this.acc === this.samplesPerChunk) {
                                    // Float32 [-1,1] -> PCM16LE
                                    const pcm = new Int16Array(this.samplesPerChunk);
                                    for (let j = 0; j < pcm.length; j++) {
                                        let s = Math.max(-1, Math.min(1, this.tmp[j]));
                                        pcm[j] = (s < 0 ? s * 0x8000 : s * 0x7FFF) | 0;
                                    }
                                    this.port.postMessage(pcm.buffer, [pcm.buffer]);
                                    this.acc = 0;
                                }
                            }
                            return true;
                        }
                    }
                    registerProcessor('capture', CaptureProcessor);

                    class PlayerProcessor extends AudioWorkletProcessor {
                        constructor() {
                            super();
                            this.samplesPerBlock = 128;
                            this.frameCount = 0;
                            this.lastLogTime = 0;
                            this.buffer = null;
                            
                            // –ü–æ–ª—É—á–∞–µ–º –±—É—Ñ–µ—Ä —á–µ—Ä–µ–∑ port
                            this.port.onmessage = (e) => {
                                console.log('PlayerProcessor: –ø–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', e.data.type);
                                if (e.data.type === 'setBuffer') {
                                    this.buffer = e.data.buffer;
                                    console.log('PlayerProcessor: –±—É—Ñ–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —Ä–∞–∑–º–µ—Ä=' + (this.buffer ? this.buffer.len : 'null'));
                                }
                            };
                        }
                        
                        process(inputs, outputs, params) {
                            const output = outputs[0][0];
                            
                            // –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
                            const now = Date.now();
                            if (now - this.lastLogTime > 2000) {
                                console.log('PlayerProcessor: frame=' + this.frameCount + ', –±—É—Ñ–µ—Ä=' + (this.buffer ? this.buffer.len : 'null') + ', need=' + output.length);
                                this.lastLogTime = now;
                            }
                            
                            // –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤
                            if (this.frameCount === 0) {
                                console.log('PlayerProcessor: –ø–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ process, –±—É—Ñ–µ—Ä=' + (this.buffer ? this.buffer.len : 'null'));
                            }
                            
                            if (!this.buffer) {
                                output.fill(0);
                                return true;
                            }
                            
                            const need = output.length;
                            const data = this.buffer.pull(need);
                            if (data) {
                                output.set(data);
                                this.frameCount++;
                            } else {
                                output.fill(0);
                            }
                            return true;
                        }
                    }
                    registerProcessor('player', PlayerProcessor);
                `], { type: 'application/javascript' })));

                // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                micStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: CHANNELS,
                        sampleRate: SAMPLE_RATE,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: false
                    }
                });

                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∑–∞—Ö–≤–∞—Ç –∞—É–¥–∏–æ
                const micSource = audioCtx.createMediaStreamSource(micStream);
                const capture = new AudioWorkletNode(audioCtx, 'capture');
                micSource.connect(capture);

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                capture.port.onmessage = (e) => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        const frame = makeFrame(e.data, 1);
                        ws.send(frame);
                    }
                };

                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                const player = new AudioWorkletNode(audioCtx, 'player');
                player.connect(audioCtx.destination);
                
                // –ü–µ—Ä–µ–¥–∞–µ–º –±—É—Ñ–µ—Ä –≤ PlayerProcessor —á–µ—Ä–µ–∑ port
                player.port.postMessage({type: 'setBuffer', buffer: playBuffer});
                log('–ë—É—Ñ–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ PlayerProcessor');
                
                // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ AudioContext
                log(`AudioContext —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${audioCtx.state}`);
                if (audioCtx.state === 'suspended') {
                    log('AudioContext –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å...');
                    await audioCtx.resume();
                    log(`AudioContext —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ resume: ${audioCtx.state}`);
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                started = true;
                startAudioBtn.disabled = true;
                stopAudioBtn.disabled = false;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                document.getElementById('sampleRate').textContent = SAMPLE_RATE;
                document.getElementById('channels').textContent = CHANNELS;
                document.getElementById('chunkSize').textContent = CHUNK_MS;
                document.getElementById('micStatus').textContent = '–ê–∫—Ç–∏–≤–µ–Ω';
                document.getElementById('playStatus').textContent = '–ì–æ—Ç–æ–≤';
                
                log('–ê—É–¥–∏–æ –∑–∞–ø—É—â–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ');
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞—É–¥–∏–æ: ${error.message}`);
                alert(`–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∞—É–¥–∏–æ: ${error.message}`);
            }
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞—É–¥–∏–æ
        function stopAudio() {
            if (!started) return;
            
            log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞—É–¥–∏–æ...');
            
            if (micStream) {
                micStream.getTracks().forEach(track => track.stop());
                micStream = null;
            }
            
            if (audioCtx) {
                audioCtx.close();
                audioCtx = null;
            }
            
            started = false;
            startAudioBtn.disabled = false;
            stopAudioBtn.disabled = true;
            
            document.getElementById('micStatus').textContent = '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
            document.getElementById('playStatus').textContent = '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
            
            log('–ê—É–¥–∏–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        }

        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ
        function disconnect() {
            stopAudio();
            
            if (ws) {
                ws.close();
                ws = null;
            }
            
            connected = false;
            updateStatus('disconnected', '–û—Ç–∫–ª—é—á–µ–Ω–æ');
            
            connectBtn.disabled = false;
            startAudioBtn.disabled = true;
            stopAudioBtn.disabled = true;
            disconnectBtn.disabled = true;
            
            log('–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        connectBtn.onclick = connect;
        startAudioBtn.onclick = startAudio;
        stopAudioBtn.onclick = stopAudio;
        disconnectBtn.onclick = disconnect;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        log('–ê—É–¥–∏–æ-–∫–ª–∏–µ–Ω—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
    </script>
</body>
</html>
